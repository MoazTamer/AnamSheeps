@using System.Security.Claims
@model List<SalesModel.ViewModels.ModelDailyMovement>
@{
    ViewData["Title"] = "عرض البيان اليومي لجميع المناديب";
    ViewData["Page"] = "عرض البيان اليومي لجميع المناديب";
    var isReadOnly = ViewBag.IsReadOnly ?? false;
    var userType = User.FindFirst(ClaimTypes.Role)?.Value;
    var targetDate = ViewBag.TargetDate ?? DateTime.Today.ToString("yyyy-MM-dd");
}

<link rel="stylesheet" href="~/css/ViewDailyMovement.css" media="print" />

<div class="d-flex flex-column flex-column-fluid">
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <div id="kt_app_content_container" class="app-container container-fluid">

        <!--begin::Page header-->
        <div class="card mb-5">
            <div class="card-body py-5">
                <!-- Desktop Layout -->
                <div class="d-none d-lg-flex align-items-center justify-content-between">
                    <div>
                        <h1 class="page-heading d-flex flex-column align-items-start mb-0">
                            <span class="text-dark fw-bold fs-1">عرض البيان اليومي لجميع المناديب</span>
                        </h1>
                        <div class="text-dark mt-2 fs-7">
                            <i class="ki-duotone ki-calendar fs-6 me-1">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            التاريخ: @targetDate
                        </div>
                    </div>

                    <div class="d-flex align-items-center gap-3">
                        <!-- زر البحث بالتاريخ -->
                        <div class="d-flex align-items-center gap-2 bg-light rounded p-2">
                            <input type="date" id="dateFilter" class="form-control border-0 bg-transparent" value="@targetDate" />
                                <button type="button" class="btn btn-primary px-4 d-flex align-items-center" onclick="filterByDate()">
                                    <i class="ki-duotone ki-search fs-3 me-2 d-none d-sm-inline">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    <span>بحث</span>
                                </button>

                        </div>

                        @if (userType == "إدارة" || User.IsInRole("إدارة"))
                        {
                            <!-- زر الطباعة -->
                            <button type="button" class="btn btn-success" onclick="printReport()">
                                <i class="ki-duotone ki-printer fs-4">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <span class="d-none d-md-inline">طباعة التقرير</span>
                            </button>
                        }

                        <!-- زر الرجوع -->
                        <a href="@Url.Action("Index", "Home")"
                           class="btn btn-light-primary">
                            <i class="ki-duotone ki-arrow-right fs-4">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <span class="d-none d-md-inline">رجوع</span>
                        </a>
                    </div>
                </div>

                <!-- Mobile Layout -->
                <div class="d-flex d-lg-none flex-column gap-4">
                    <!-- العنوان والتاريخ -->
                    <div class="text-center">
                        <h1 class="text-dark fw-bold fs-3 mb-2">عرض البيان اليومي لجميع المناديب</h1>
                        <div class="text-dark fs-7 d-flex align-items-center justify-content-center">
                            <i class="ki-duotone ki-calendar fs-6 me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <span>التاريخ: @targetDate</span>
                        </div>
                    </div>

                    <!-- البحث -->
                    <div class="d-flex flex-column gap-3">
                        <div class="d-flex gap-2 align-items-stretch">
                            <input type="date" id="dateFilterMobile" class="form-control flex-grow-1 border-primary" value="@targetDate" style="min-height: 45px;" />
                            <button type="button" class="btn btn-primary px-4 d-flex align-items-center" onclick="filterByDate()">
                                <i class="ki-duotone ki-search fs-3 me-2 d-none d-sm-inline">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <span>بحث</span>
                            </button>
                        </div>
                    </div>

                    <!-- الأزرار -->
                    <div class="d-flex gap-2 justify-content-center">
                        @if (userType == "إدارة" || User.IsInRole("إدارة"))
                        {
                            <!-- زر الطباعة -->
                            <button type="button" class="btn btn-success flex-grow-1 d-flex align-items-center justify-content-center" onclick="printReport()">
                                <i class="ki-duotone ki-printer fs-3 me-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <span>طباعة</span>
                            </button>
                        }

                        <!-- زر الرجوع -->
                        <a href="@Url.Action("Index", "Home")"
                           class="btn btn-light-primary flex-grow-1 d-flex align-items-center justify-content-center">
                            <i class="ki-duotone ki-arrow-right fs-3 me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <span>رجوع</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <!--end::Page header-->
        @if (!Model.Any())
            {
                <div class="card">
                    <div class="card-body text-center py-10">
                        <i class="ki-duotone ki-information fs-2hx text-muted">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        <div class="text-muted fs-4 mt-3">لا توجد حركات للمناديب في هذا التاريخ</div>
                    </div>
                </div>
            }
            else
            {
                foreach (var movement in Model)
                {
                    <div class="card mb-10">
                        <!--begin::Header-->
                        <div class="card-header border-0 bg-primary bg-opacity-10">
                            <div class="card-title d-flex align-items-center">
                                <i class="ki-duotone ki-user-tick fs-2x text-primary me-3">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <div>
                                    <h3 class="fw-bold text-dark mb-1">المندوب: @movement.userName</h3>
                                    <div class="text-muted fs-7">رقم الحركة: @movement.DailyMovement_ID</div>
                                </div>
                            </div>
                            <div class="card-toolbar">
                                <a href="@Url.Action("ViewDailyMovement", "ManagementDashboard", new { movementId = movement.DailyMovement_ID })"
                                   class="btn btn-light-primary">
                                    <i class="ki-duotone ki-eye fs-3">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                    </i>
                                    عرض التفاصيل
                                </a>
                            </div>
                        </div>
                        <!--end::Header-->

                        <div class="card-body">
                            <!--begin::Details-->
                            @if (movement.Details.Any())
                            {
                                <div class="card mb-5">
                                    <div class="card-header">
                                        <h3 class="card-title">تفاصيل المشتريات</h3>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="table-responsive">
                                            @* <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3"> *@
                                            <table class="table table-row-bordered align-middle">
                                                <thead>
                                                    <tr class="fw-bold text-dark bg-light">
                                                        <th class="min-w-150px">المنتج</th>
                                                        <th class="min-w-100px text-center">الكمية</th>
                                                        <th class="min-w-100px text-end">السعر</th>
                                                        <th class="min-w-100px text-end">الإجمالي</th>
                                                        <th class="min-w-120px text-center">نوع الدفع</th>
                                                        <th class="min-w-150px">ملاحظات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var detail in movement.Details)
                                                    {
                                                        <tr>
                                                            <td class="text-dark fw-bold">@detail.Product_Name</td>
                                                            <td class="text-center fw-bold">
                                                                <span class="badge fw-bold fs-6">@detail.DailyMovementDetails_Quantity</span>
                                                            </td>
                                                            <td class="text-end fw-bold">@detail.DailyMovementDetails_Price.ToString("N2")</td>
                                                            <td class="text-end fw-bold">@detail.DailyMovementDetails_Total.ToString("N2")</td>
                                                            <td class="text-center">
                                                                <span class="badge fw-bold fs-6">@detail.DailyMovementDetails_PaymentType</span>
                                                            </td>
                                                            <td class="fw-bold">@detail.DailyMovementDetails_Notes</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }
                            <!--end::Sales-->
                            <!--begin::Sales-->
                            @if (movement.Sales.Any())
                            {
                                <div class="card mb-5">
                                    <div class="card-header">
                                        <h3 class="card-title">تفاصيل المبيعات</h3>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="table-responsive">
                                            <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                                <thead>
                                                    <tr class="fw-bold text-dark bg-light">
                                                        <th class="min-w-150px">المنتج</th>
                                                        <th class="min-w-100px text-center">الكمية</th>
                                                        <th class="min-w-100px text-end">السعر</th>
                                                        <th class="min-w-100px text-end">الإجمالي</th>
                                                        <th class="min-w-120px text-center">نوع الدفع</th>
                                                        <th class="min-w-150px">ملاحظات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var sale in movement.Sales)
                                                    {
                                                        <tr>
                                                            <td class="text-dark fw-bold">@sale.Product_Name</td>
                                                            <td class="text-center">
                                                                <span class="badge fw-bold fs-6">@sale.DailyMovementSales_Quantity</span>
                                                            </td>
                                                            <td class="text-end fw-bold">@sale.DailyMovementSales_Price.ToString("N2")</td>
                                                            <td class="text-end fw-bold">@sale.DailyMovementSales_Total.ToString("N2")</td>
                                                            <td class="text-center">
                                                                <span class="badge fw-bold fs-6">@sale.DailyMovementSales_PaymentType</span>
                                                            </td>
                                                            <td class="fw-bold">@sale.DailyMovementSales_Notes</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }
                            <!--end::Sales-->
                            <!--begin::Expenses-->
                            @if (movement.Expenses.Any())
                            {
                                <div class="card mb-5">
                                    <div class="card-header">
                                        <h3 class="card-title">المصروفات</h3>
                                    </div>
                                    <div class="card-body p-4">
                                        <div class="table-responsive">
                                            <table class="table table-row-bordered table-row-gray-100 align-middle gs-0 gy-3">
                                                <thead>
                                                    <tr class="fw-bold text-dark bg-light">
                                                        <th class="min-w-150px">بند المصروف</th>
                                                        <th class="min-w-100px text-center">الكمية</th>
                                                        <th class="min-w-100px text-end">المبلغ</th>
                                                        <th class="min-w-100px text-end">الإجمالي</th>
                                                        <th class="min-w-200px">ملاحظات</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var expense in movement.Expenses)
                                                    {
                                                        <tr>
                                                            <td class="text-dark fw-bold">@expense.DailyMovementExpense_CategoryName</td>
                                                            <td class="text-center">
                                                                <span class="badge fw-bold fs-6">@expense.DailyMovementExpense_Quantity</span>
                                                            </td>
                                                            <td class="text-end fw-bold">@expense.DailyMovementExpense_Amount.ToString("N2")</td>
                                                            <td class="text-end fw-bold">@expense.DailyMovementExpense_Total.ToString("N2")</td>
                                                            <td class="fw-bold">@expense.DailyMovementExpense_Notes</td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }
                            <!--end::Expenses-->
                            <!--begin::Two Column Section-->
                            <div class="row g-5 mb-5">
                                <!--begin::Suppliers-->
                                @if (movement.Suppliers.Any())
                                {
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">الموردين</h3>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-row-bordered align-middle">
                                                        <thead>
                                                            <tr class="fw-bold text-dark bg-light">
                                                                <th>المورد</th>
                                                                <th>المبلغ</th>
                                                                <th>طريقة الدفع</th>
                                                                <th>الملاحظات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var supplier in movement.Suppliers)
                                                            {
                                                                <tr>
                                                                    <td class="text-dark fw-bold">@supplier.DailyMovementSupplier_SupplierName</td>
                                                                    <td class="fw-bold fs-5">@supplier.DailyMovementSupplier_Amount.ToString("N2")</td>
                                                                    <td class="fw-bold">@supplier.DailyMovementSupplier_PaymentType</td>
                                                                    <td class="fw-bold">@supplier.DailyMovementSupplier_Notes</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <!--end::Suppliers-->
                                <!--begin::Customers-->
                                @if (movement.Customers.Any())
                                {
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">العملاء</h3>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-row-bordered align-middle">
                                                        <thead>
                                                            <tr class="fw-bold text-dark bg-light">
                                                                <th class="text-center">العميل</th>
                                                                <th class="text-center">المبلغ</th>
                                                                <th class="text-center">طريقة الدفع</th>
                                                                <th class="text-center">ملاحظات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var customer in movement.Customers)
                                                            {
                                                                <tr>
                                                                    <td class="text-center text-dark fw-bold">@customer.DailyMovementCustomer_CustomerName</td>
                                                                    <td class="text-center fw-bold fs-5">@customer.DailyMovementCustomer_Amount.ToString("N2")</td>
                                                                    <td class="text-center fw-bold fs-5">@customer.DailyMovementCustomer_PaymentType</td>
                                                                    <td class="text-center fw-bold fs-5">@customer.DailyMovementCustomer_Notes</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <!--end::Customers-->
                            </div>
                            <!--end::Two Column Section-->
                            <!--begin::Two Column Section-->
                            <div class="row g-5 mb-5">
                                <!--begin::Taslim-->
                                @if (movement.Taslim.Any())
                                {
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">تسليم للإدارة</h3>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-row-bordered align-middle">
                                                        <thead>
                                                            <tr class="fw-bold text-dark bg-light">
                                                                <th>المستلم</th>
                                                                <th>المبلغ</th>
                                                                <th>الملاحظات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var taslim in movement.Taslim)
                                                            {
                                                                <tr>
                                                                    <td class="text-dark fw-bold">@taslim.DailyMovementTaslim_Receiver</td>
                                                                    <td class="fw-bold fs-5">@taslim.DailyMovementTaslim_Amount.ToString("N2")</td>
                                                                    <td class="fw-bold">@taslim.DailyMovementTaslim_Notes</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <!--end::Taslim-->
                                <!--begin::Warid-->
                                @if (movement.Warid.Any())
                                {
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">وارد من الإدارة</h3>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-row-bordered align-middle">
                                                        <thead>
                                                            <tr class="fw-bold text-dark bg-light">
                                                                <th>المستلم</th>
                                                                <th>المبلغ</th>
                                                                <th>الملاحظات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var warid in movement.Warid)
                                                            {
                                                                <tr>
                                                                    <td class="text-dark fw-bold">@warid.DailyMovementWarid_Receiver</td>
                                                                    <td class="fw-bold">@warid.DailyMovementWarid_Amount.ToString("N2")</td>
                                                                    <td class="fw-bold">@warid.DailyMovementWarid_Notes</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                                <!--end::Warid-->
                            </div>
                            <!--end::Two Column Section-->
                           
                            
                            <!--end::Two Column Section-->
                            <div class="row g-5 mb-5">

                            <!--begin::Balances-->
                            @if (movement.Balances.Any())
                            {
                                <div class="row g-5 no-print">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h3 class="card-title">الأرصدة</h3>
                                            </div>
                                            <div class="card-body p-4">
                                                <div class="table-responsive">
                                                    <table class="table table-row-bordered align-middle">
                                                        <thead>
                                                            <tr class="fw-bold text-dark bg-light">
                                                                <th>النوع</th>
                                                                <th class="text-end">المبلغ</th>
                                                                <th>ملاحظات</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var balance in movement.Balances)
                                                            {
                                                                <tr>
                                                                    <td><span class="badge fw-bold">@balance.DailyMovementBalance_Type</span></td>
                                                                    <td class="text-end fw-bold fs-6">@balance.DailyMovementBalance_Amount.ToString("N2")</td>
                                                                    <td class="text-fark fw-bold">@balance.DailyMovementBalance_Notes</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                        <tfoot>
                                                            @{
                                                                decimal correctTotal = 0;

                                                                foreach (var balance in movement.Balances)
                                                                {
                                                                    if (balance.DailyMovementBalance_Type.Contains('+'))
                                                                    {
                                                                        correctTotal += balance.DailyMovementBalance_Amount;
                                                                    }
                                                                    else if (balance.DailyMovementBalance_Type.Contains('-'))
                                                                    {
                                                                        correctTotal -= balance.DailyMovementBalance_Amount;
                                                                    }
                                                                    else
                                                                    {
                                                                        if (balance.DailyMovementBalance_Type == "رصيد سابق")
                                                                        {
                                                                            correctTotal += balance.DailyMovementBalance_Amount;
                                                                        }
                                                                    }
                                                                }

                                                                var totalClass = correctTotal >= 0 ? "text-success" : "text-danger";
                                                            }
                                                            <tr class="fw-bold bg-light">
                                                                <td class="text-end">الإجمالي</td>
                                                                <td class="text-end fw-bold @totalClass">
                                                                    @correctTotal.ToString("N2")
                                                                </td>
                                                                <td></td>
                                                            </tr>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <!--end::Balances-->
                            <!--مستودع-->
                            @if (movement.Mortality.Any())
                            {
                                <div class="col-md-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">النفوق والمستهلك</h3>
                                        </div>
                                        <div class="card-body p-4">
                                            <div class="table-responsive">
                                                <table class="table table-row-bordered align-middle">
                                                    <thead>
                                                        <tr class="fw-bold text-dark bg-light">
                                                            <th>الصنف</th>
                                                            <th>العدد</th>
                                                            <th>الملاحظات</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var mor in movement.Mortality)
                                                        {
                                                            <tr>
                                                                <td class="text-dark fw-bold">@mor.Product_Name</td>
                                                                <td class="fw-bold fs-5">@mor.WarehouseMortality_Quantity.ToString("N2")</td>
                                                                <td class="fw-bold">@mor.WarehouseMortality_Notes</td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                        </div>
                        </div>
                    </div>
                }
            }

        </div>
    </div>
</div>

@section Scripts {
    <script>
        function printReport() {
            window.print();
        }

        function filterByDate() {
            var date =
                document.getElementById('dateFilter')?.value ||
                document.getElementById('dateFilterMobile')?.value;

            if (date && date.length >= 8) {
                window.location.href =
                    '@Url.Action("ViewAllDailyMovements", "ManagementDashboard")' + '?date=' + date;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var today = new Date().toISOString().split('T')[0];

            document.querySelectorAll('input[type="date"]').forEach(function (input) {
                if (!input.value) input.value = today;
            });

        });
    </script>

}